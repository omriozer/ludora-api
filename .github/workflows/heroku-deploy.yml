name: Deploy to Heroku

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
    types:
      - closed
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy API to Heroku
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true) || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get commit message
        id: commit
        run: |
          COMMIT_MSG=$(git log -1 --pretty=format:"%s")
          echo "message<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMIT_MSG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Notify deployment started
        uses: ./.github/actions/telegram-notify
        continue-on-error: true
        with:
          bot-token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          chat-id: ${{ secrets.TELEGRAM_CHAT_ID }}
          status: 'started'
          service: 'API (Heroku)'
          commit-message: ${{ steps.commit.outputs.message }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Heroku CLI
        run: |
          curl https://cli-assets.heroku.com/install.sh | sh
          echo "Heroku CLI installed successfully"

      - name: Authenticate Heroku CLI
        run: |
          echo "${{ secrets.HEROKU_API_KEY }}" | heroku auth:token
          heroku auth:whoami
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}

      - name: Sync environment variables
        run: |
          echo "Syncing environment variables for production..."
          echo "ğŸ”§ Setting AWS credentials from GitHub Secrets..."
          heroku config:set \
            AWS_ACCESS_KEY_ID="${{ secrets.AWS_ACCESS_KEY_ID_PROD }}" \
            AWS_SECRET_ACCESS_KEY="${{ secrets.AWS_SECRET_ACCESS_KEY_PROD }}" \
            AWS_S3_BUCKET="ludora-files-prod" \
            --app ludora-api-prod
          echo "âœ… AWS credentials synchronized!"
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}

      - name: Check for dependency changes
        id: deps-check
        run: |
          git diff HEAD~1 HEAD -- package.json package-lock.json > /dev/null 2>&1
          if [ $? -eq 0 ]; then
            echo "changes=true" >> $GITHUB_OUTPUT
          else
            echo "changes=false" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Test migrations before deployment
        run: |
          echo "ğŸ” Testing migrations in dry-run mode..."
          heroku run "ENVIRONMENT=production node scripts/safe-migrate.js --dry-run" --app ludora-api-prod || {
            echo "âŒ Migration dry-run failed! Deployment aborted."
            exit 1
          }
          echo "âœ… Migration dry-run successful"
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}

      - name: Run database migrations SAFELY
        run: |
          echo "ğŸš€ Running safe transactional migrations..."
          heroku run "ENVIRONMENT=production node scripts/safe-migrate.js" --app ludora-api-prod || {
            echo "âŒ CRITICAL: Migration failed! Deployment aborted."
            echo "Database state preserved due to transaction rollback."
            exit 1
          }
          echo "âœ… Safe migrations completed successfully"
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}

      - name: Deploy to Heroku Production
        run: |
          echo "âœ… Migrations successful - proceeding with deployment..."
          git push https://heroku:${{ secrets.HEROKU_API_KEY }}@git.heroku.com/ludora-api-prod.git HEAD:main || {
            echo "âŒ Deployment failed after successful migrations!"
            echo "âš ï¸ Database has been migrated but code deployment failed."
            echo "Manual intervention may be required."
            exit 1
          }
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}

      - name: Wait for deployment
        run: |
          echo "Waiting for Heroku deployment to complete..."
          sleep 60

      - name: Restart dynos
        run: |
          echo "Restarting Heroku dynos..."
          heroku ps:restart --app ludora-api-prod
          echo "âœ… Dynos restarted successfully"
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}

      - name: Handle dependency changes
        if: steps.deps-check.outputs.changes == 'true'
        run: |
          echo "âš ï¸ Package.json changes detected - dependencies will be updated during Heroku build"
          echo "Heroku automatically installs dependencies based on package.json during build"

      - name: Health check with migration validation
        run: |
          echo "Waiting for deployment to be ready..."
          sleep 60

          echo "ğŸ” Checking API health and migration status..."
          HEALTH_RESPONSE=$(curl -s https://api.ludora.app/health)
          HEALTH_STATUS=$(curl -s -w "%{http_code}" -o /dev/null https://api.ludora.app/health)

          echo "Health check response:"
          echo "$HEALTH_RESPONSE" | jq . || echo "$HEALTH_RESPONSE"

          if [ "$HEALTH_STATUS" -eq "200" ]; then
            echo "âœ… API production deployment successful and healthy!"
            echo "âœ… All migrations applied successfully!"
          else
            echo "âŒ Health check failed with status: $HEALTH_STATUS"
            echo "âŒ Deployment may have succeeded but system is unhealthy!"
            exit 1
          fi

      - name: Check dyno status
        run: |
          echo "Checking dyno status..."
          heroku ps --app ludora-api-prod
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}

      - name: Deployment summary
        run: |
          echo "ğŸš€ Heroku deployment completed successfully!"
          echo "API URL: https://api.ludora.app"
          echo "Health Check: https://api.ludora.app/health"
          echo "Heroku Dashboard: https://dashboard.heroku.com/apps/ludora-api-prod"

      - name: Notify deployment success
        if: success()
        uses: ./.github/actions/telegram-notify
        continue-on-error: true
        with:
          bot-token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          chat-id: ${{ secrets.TELEGRAM_CHAT_ID }}
          status: 'success'
          service: 'API (Heroku)'
          commit-message: ${{ steps.commit.outputs.message }}
          details: |
            ğŸŒ API URL: https://api.ludora.app
            â¤ï¸ Health Check: https://api.ludora.app/health
            ğŸ“Š Heroku Dashboard: https://dashboard.heroku.com/apps/ludora-api-prod

      - name: Notify deployment failure
        if: failure()
        uses: ./.github/actions/telegram-notify
        continue-on-error: true
        with:
          bot-token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          chat-id: ${{ secrets.TELEGRAM_CHAT_ID }}
          status: 'failed'
          service: 'API (Heroku)'
          commit-message: ${{ steps.commit.outputs.message }}
          details: |
            âš ï¸ ×©×œ×‘ ×›×•×©×œ: ${{ job.status }}
            ğŸ” ×‘×“×•×§ ××ª ×”×œ×•×’×™× ×œ×¤×¨×˜×™× × ×•×¡×¤×™×
